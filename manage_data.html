<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>BloodCircR</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/contact.css">
    <link rel="stylesheet" type="text/css" href="elementui/theme-chalk/index.css" />
    <link rel="icon" href="images/1_1.png" type="image/x-icon">
    <script src="js/vue.js"></script>
    <script src="js/elementui.js"></script>
	
    <script src="src/layui.js"></script>
    <script src="js/axios.min.js"></script>
    <script src="js/header-component.js"></script>
    <script src="js/footer-component.js"></script>
    <script>
        // Loading
        import { Loading } from "element-ui";
    </script>
    <style>
        #main.login {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        #main:not(.login) {
            opacity: 0;
        }
		.el-table .cell,
		.el-table th,
		.el-table td {
		    color: #333333 !important; /* 更改文字颜色为 #333333 */
		  white-space: normal !important; /* 允许文字换行 */
		    word-wrap: break-word !important; /* 长单词换行处理 */
		    overflow-wrap: break-word !important; /* 处理其他换行情况 */
		    word-break: keep-all !important; /* 保持单词完整，不随意断开 */
		}
		.el-descriptions-item__label.is-bordered-label {
		 
		    color: #333333;
		  
		}
		.el-button:hover {
			color: #B94A4A;
			border-color: #E6B7B7;
			background-color: #E6B7B7;
		}

		.el-button:active {
			color: #B94A4A;
			border-color: #E6B7B7;
			background-color: #E6B7B7;
		}

		.el-button:focus {
			color: #B94A4A;
			border-color: #E6B7B7;
			background-color: #E6B7B7;
		}


        .el-tabs--left .el-tabs__item.is-left {
            font-size: 20px;
        }

        .el-tabs__item {
            padding: 20px;
            height: 60px;
            line-height: 0;
        }

        .el-tabs--left .el-tabs__header.is-left {
            margin-top: 30px;
        }
        /* 默认样式 */
        .el-button {
            font-size: 16px; /* 默认字体大小 */
        }
        .form_label {
            font-size: 18px;
        }
        .form_text {
                font-size: 20px;
                padding-bottom: 10px;
                display: inline-block;
            }
        /* @media (min-width: 1200px) and (max-width: 1400px) {
            .el-button {
                font-size: 12px; 
            }
            .form_label {
                font-size: 14px;
            }
            .form_text {
                font-size: 16px;
            }
        }
        @media (min-width: 1100px) and (max-width: 1200px) {
            .el-button {
                font-size: 10px; 
            }
            .form_label {
                font-size: 12px;
            }
            .form_text {
                font-size: 14px;
            }
        }
        @media  (max-width: 1100px) {
            .el-button {
                font-size: 8px; 
            }
            .form_label {
                font-size: 9px;
            }
            .form_text {
                font-size: 12px;
            }
        } */
        .footer {
            min-width: 1000px;
        }
        @media (max-width: 1000px) {
  body {
    overflow-x: auto; /* 显示水平滚动条 */
    min-width: 1000px; /* 设置最小宽度，确保内容不会被压缩 */
  }
}
    </style>
	<style>
	  .form_text a {
	    color: #B94A4A; /* 修改为你想要的颜色 */
	    text-decoration: none;
	  }
	
	  .form_text a:hover {
	    text-decoration: underline;
	  }
	</style>
</head>

<body>
    <div id="app" :class="{ loaded: isLoaded }">
        <!-- 使用定义的 header 组件 -->
        <app-header></app-header>
        <div style="display: flex; flex-direction: column;min-height: 100vh; min-width: 1000px; margin:0">
            <!-- head1 -->
             <div style="flex:1">
                <div class="main" id="main" :class="{ login: isLogin }" style="margin-top: 120px;min-width: 1000px;">
                    <el-tabs tab-position="left" style="margin: 20px 0 0 10px;">
                        <el-tab-pane label="Manage Data">
                            <div style="padding:0 40px;">
                                <div class="header" style="font-size: 28px;">
                                    Manage your data
                                </div>
                            </div>

                            <!-- head2 -->
                            <div style="padding:0 40px;">
                                <div class="header_sub">
                                    <span>You can upload your own dataset and fill in the form below, uploaded datasets will be
                                        analyzed
                                        in Expression module.</span>
                                </div>
                            </div>

                            <!-- 上传数据表单 -->
                            <div style="padding:0 40px;">
                                <div class="form">
                                   <span class="form_text">If needed, you can refer to the <a href="Description Document.html">data upload instructions</a>.</span>
                                    <el-form ref="form" :model="form" :rules="rules" label-width=50px" label-position="left">
                                        <el-row>
                                            <el-col :span="11">
                                                <el-form-item prop="datasetname">
                                                    <span slot="label" class="form_label" style="color:#333333;">DatasetID:</span>
                                                    <el-input v-model="form.datasetname" placeholder="eg.BloodHCC224"
                                                        style="width:250px;"></el-input>
                                                </el-form-item>
                                            </el-col>
                                            <el-col :span="13">
                                            </el-col>
                                        </el-row>
                                            <el-row>
                                                <el-col :span="11">
                                                    <el-form-item prop="disease">
                                                        <span slot="label" class="form_label" style="color:#333333;">Disease type:</span>
                                                        <el-select v-model="form.disease" placeholder="Select/Input disease"
                                                        filterable allow-create clearable style="width: 250px">
                                                            <el-option v-for="disease in diseases" :key="disease" :label="disease"
                                                                :value="disease"></el-option>
                                                        </el-select>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="11">
                                                    <el-form-item prop="phenotype">
                                                        <span slot="label" class="form_label" style="color:#333333;">Phenotype:</span>
                                                        <el-input v-model="form.phenotype" placeholder="eg.HCC"
                                                            style="width:250px;"></el-input>
                                                    </el-form-item>
                                                </el-col>
                                                <el-col :span="2">
                                                </el-col>
                                            </el-row>
                                        <el-row>
                                        <el-col :span="12">
                                            <el-form-item prop="filename1">
                                                <span slot="label" class="form_label" style="color:#333333;">Sample info:</span>
                                                <div style="display: flex; align-items: end;">
                                                    <el-upload class="upload-demo" ref="upload"
                                                        :data="{action:'upload', fileName: 'sampleinfo'}"
                                                        :http-request="uploadFile" :on-success="handleFile1Success"
                                                        :on-error="handleFileError" :limit="1">
                                                        <el-button type="primary">Select File1</el-button>
                                                    </el-upload>
                                                    <!-- <el-button type="primary" style="margin-left: 10px;"
                                                        @click="download1()">Download Example_SampleInfo</el-button> -->
                                                </div>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="12">
                                            <el-form-item prop="filename2">
                                                <span slot="label" class="form_label" style="color:#333333;">Isoform info:</span>
                                                <div style="display: flex; align-items: end;">
                                                    <el-upload class="upload-demo" ref="upload"
                                                        :data="{action:'upload', fileName: 'isoforminfo'}"
                                                        :http-request="uploadFile" :on-success="handleFile2Success"
                                                        :on-error="handleFileError" :limit="1">
                                                        <el-button type="primary">Select File2</el-button>
                                                    </el-upload>
                                                    <!-- <el-button type="primary" style="margin-left: 10px;"
                                                        @click="download2()">Download Example_IsoformInfo</el-button> -->
                                                </div>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                    <el-row>
                                        <el-col :span="12">
                                            <el-form-item prop="filename3">
                                                <span slot="label" class="form_label" style="color:#333333;">Count matrix:</span>
                                                <div style="display: flex; align-items: end;">
                                                    <el-upload class="upload-demo" ref="upload"
                                                        :data="{action:'upload', fileName: 'Countmatrix'}"
                                                        :http-request="uploadFile" :on-success="handleFile3Success"
                                                        :on-error="handleFileError" :limit="1">
                                                        <el-button type="primary">Select File3</el-button>
                                                    </el-upload>
                                                    <!-- <el-button type="primary" style="margin-left: 10px;"
                                                        @click="download3()">Download Example_CountMatrix</el-button> -->
                                                </div>
                                            </el-form-item>
                                        </el-col>
                                        <el-col :span="12">
                                            <el-form-item prop="filename4">
                                                <span slot="label" class="form_label" style="color:#333333;">TPM matrix:</span>
                                                <div style="display: flex; align-items: end;">
                                                    <el-upload class="upload-demo" ref="upload"
                                                        :data="{action:'upload', fileName: 'TPMmatrix'}"
                                                        :http-request="uploadFile" :on-success="handleFile4Success"
                                                        :on-error="handleFileError" :limit="1">
                                                        <el-button type="primary">Select File4</el-button>
                                                    </el-upload>
                                                    <!-- <el-button type="primary" style="margin-left: 10px;"
                                                        @click="download4()">Download Example_TPMMatrix</el-button> -->
                                                </div>
                                            </el-form-item>
                                        </el-col>
                                    </el-row>
                                    
                                    </el-form>

                                    <div style="padding:10px 0">
                                        <el-button type="primary" @click="submitForm"
                                            style="width:100px;margin-right: 50px;">Submit</el-button>
                                        <el-button type="primary" @click="resetForm" style="width:100px;">Reset</el-button>
                                    </div>
                                </div>
                            </div>


                            <!-- 数据展示交互 -->
                            <div style="padding:0 40px;">
                                <div class="form">

                                    <!-- 搜索 -->
                                    <div style="display: flex; margin-bottom: 20px;">
                                        <div style="width: 30%; display: flex;">
                                            <div style="width: 40%;">
                                                <!-- 下拉选择框 -->
                                                <el-select v-model="searchField" placeholder="Select Field">
                                                    <el-option label="DatasetID" value="Dataset"></el-option>
                                                    <el-option label="Disease type" value="Disease"></el-option>
                                                    <el-option label="Phenotype" value="Phenotype"></el-option>
                                                    <!-- <el-option label="Group" value="Group"></el-option> -->
                                                </el-select>
                                            </div>
                                            <div style="width: 60%; padding-left: 20px;">
                                                <!-- 搜索输入框 -->
                                                <el-input v-model="searchKeyword" placeholder="Search content" clearable
                                                    @keyup.enter.native="handleSearch" style="width: 100%">
                                                    <!-- <el-button slot="append" icon="el-icon-search"></el-button> -->
                                                </el-input>
                                            </div>
                                        </div>

                                        <div style="width: 70%; display: flex; padding-left: 20px;">
                                            <div style="width: 50%; display: flex; justify-content: center;">
                                                <!-- <span style="font-weight: 700; line-height: 40px; margin-right: 20px;">Upload
                                                    time:</span> -->
                                                <el-date-picker v-model="startTime" type="date" style="margin-right: 20px;"
                                                    placeholder="Pick start day"></el-date-picker>
                                                <el-date-picker v-model="endTime" type="date"
                                                    placeholder="Pick end day"></el-date-picker>
                                            </div>
                                            <div style="width: 50%; display: flex; justify-content: center;">
                                                <el-button type="primary" @click="handleSearch"
                                                    style="width:100px;margin-right: 20px;">Search</el-button>
                                                <el-button type="primary" @click="resetSearch"
                                                    style="width:100px;">Reset</el-button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 表格交互 -->
                                    <el-table :data="displayData" border style="width: 100%" row-key='id' v-loading="loading"
                                        element-loading-text="Loading" element-loading-spinner="el-icon-loading"
                                        element-loading-background="rgba(255, 255, 255, 0.8)" style="text-align: center;">
                                        <el-table-column type="index" :index="getIndex" width="70" label="ID"></el-table-column>
                                        <el-table-column prop="filename1" label="Sample info" :width="110"></el-table-column>
                                        <el-table-column prop="filename2" label="Isoform info" :width="110"></el-table-column>
                                        <el-table-column prop="filename3" label="Count matrix" :width="110"></el-table-column>
                                        <el-table-column prop="filename4" label="TPM matrix" :width="110"></el-table-column>
                                        <el-table-column prop="Dataset" label="DatasetID":width="90"></el-table-column>
                                        <el-table-column prop="Disease" label="Disease type" :width="110"></el-table-column>
                                        <el-table-column prop="Phenotype" label="Phenotype" :width="110"></el-table-column>
                                        <!-- <el-table-column prop="Group" label="Group"></el-table-column> -->
                                        <el-table-column prop="time" label="Upload time" ></el-table-column>
                                        <el-table-column label="Operation" header-align="center" :width="270">
                                            <template #default="scope">
                                                <div style="display: flex; justify-content: space-evenly;">
                                                    <el-button type="primary"
                                                        @click="handleModify(scope.$index, scope.row)">Modify</el-button>
                                                    <el-button type="primary"
                                                        @click="handleDelete(scope.$index, scope.row)">Delete</el-button>
                                                </div>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                    <el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange"
                                        :current-page="currentPage" :page-sizes="pageSizes" :page-size="pageSize"
                                        layout="sizes, prev, pager, next, jumper" :total="total" style="margin-top: 20px">
                                    </el-pagination>
                                    <div>
                                        <el-dialog title="Modify Data" :visible="editDialog" append-to-body="true"
                                            @close="closeDialog">
                                            <el-form ref="formData" :model="formData" :rules="rules1" label-width="100px">
                                                <el-row>
                                                    <el-col :span="12">
                                                        <el-form-item label="datasetname" prop="Dataset" label-width="120px">
                                                            <el-input v-model="formData.Dataset"></el-input>
                                                        </el-form-item>
                                                    </el-col>
                                                    <el-col :span="12">
                                                        <el-form-item label="disease" prop="Disease" label-width="120px">
                                                            <el-input v-model="formData.Disease"></el-input>
                                                        </el-form-item>
                                                    </el-col>
                                                </el-row>
                                                <el-row>
                                                    <el-col :span="12">
                                                        <el-form-item label="phenotype" prop="Phenotype" label-width="120px">
                                                            <el-input v-model="formData.Phenotype"></el-input>
                                                        </el-form-item>
                                                    </el-col>
                                                    <!-- <el-col :span="12">
                                                        <el-form-item label="group" prop="Group" label-width="120px">
                                                            <el-input v-model="formData.Group"></el-input>
                                                        </el-form-item>
                                                    </el-col> -->
                                                </el-row>
                                                <el-form-item>
                                                    <el-button type="primary" @click="handleSubmitForm">Submit</el-button>
                                                </el-form-item>
                                            </el-form>
                                        </el-dialog>
                                    </div>
                                    <el-dialog title="Delete Data" :visible="deleteVisible" width="30%" @close="closeDialog1">
                                        <span>Are you sure?</span>
                                        <span slot="footer" class="dialog-footer">
                                            <el-button @click="deleteVisible = false">Cancel</el-button>
                                            <el-button type="primary" @click="deleteData()">Confirm</el-button>
                                        </span>
                                    </el-dialog>
                                    <!-- 滚动到顶部的按钮 -->
                            
                                </div>
                            </div>
                        </el-tab-pane>
                        <el-tab-pane label="Manage Account">
                            <div style="padding:0 40px;">
                                <div class="header" style="font-size: 28px;">
                                    Manage your account
                                </div>
                            </div>

                            <div style="padding:0 40px;">
                                <div class="header_sub">
                                    <span>You can update your personal information in the card below and change your password in
                                        the second card. Remember to submit your changes.</span>
                                </div>
                            </div>

                            <el-card class="box-card" style="margin:0 40px;">
                                <div slot="header" class="clearfix" style="color: #B94A4A; font-size: 20px;">
                                    <span>Personal Information</span>
                                </div>
                            <el-descriptions direction="horizontal" :column="1" border>
                                <el-descriptions-item label="First name">
                                    <el-input v-model="tempData.name" @blur="handleInputBlur('First name')"
                                        placeholder="Please input first name"></el-input>
                                </el-descriptions-item>
                                <el-descriptions-item label="Last name">
                                    <el-input v-model="tempData.birthday" @blur="handleInputBlur('Last name')"
                                        placeholder="Please input last name"></el-input>
                                </el-descriptions-item>
                                <el-descriptions-item label="Sex">
                                    <el-input v-model="tempData.sex" @blur="handleInputBlur('sex')"
                                        placeholder="Please input sex"></el-input>
                                </el-descriptions-item>
                                <el-descriptions-item label="Career">
                                    <el-input v-model="tempData.career" @blur="handleInputBlur('career')"
                                        placeholder="Please input career"></el-input>
                                </el-descriptions-item>
                                <el-descriptions-item label="Address">
                                    <el-input v-model="tempData.address" @blur="handleInputBlur('address')"
                                        placeholder="Please input address"></el-input>
                                </el-descriptions-item>
                            </el-descriptions>
                            </el-card>

                            <el-card class="box-card" style="margin:20px 40px 0 40px;">
                                <div slot="header" class="clearfix" style="color:#B94A4A; font-size: 20px;">
                                    <span>Login Information</span>
                                </div>
                                <el-descriptions direction="horizontal" :column="1" border>
                                    <el-descriptions-item label="Email">
                                        <el-input v-model="tempData.email" disabled></el-input>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="Password">
                                        <el-input v-model="tempData.password" type="password" required=true
                                            placeholder="*Please input password"></el-input>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="Re-type password">
                                        <el-input v-model="tempData.repassword" type="password" required=true
                                            placeholder="*Please input re-type password"></el-input>
                                    </el-descriptions-item>
                                </el-descriptions>
                            </el-card>

                            <div style="margin: 20px 0 0 50px;">
                                <el-button type="primary" @click="handleSubmit"
                                    style="width:100px;margin-right: 20px;">Submit</el-button>
                                <el-button type="primary" @click="handleReset" style="width:100px;">Reset</el-button>
                            </div>
                        </el-tab-pane>
                    </el-tabs>


                </div>
            </div>
            <!-- 使用定义的 footer 组件 -->
            <app-footer></app-footer>
        </div>
    </div>
</body>

<!-- vue相关js -->
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                isLoaded: false,
                loading: true,
                isLogin: JSON.parse(localStorage.getItem('user')) || null,
                form: {
                    filename1: '',
                    filename2: '',
                    filename3: '',
                    filename4: '',
                    datasetname: '',
                    disease: '',
                    phenotype: '',
                    // group: '',
                },
                formData: {
                    id: '',
                    Dataset: '',
                    Disease: '',
                    Phenotype: '',
                    // Group: '',
                },
                rules: {
                    filename1: [{ required: true, message: 'Dataset File1 is required' }],
                    filename2: [{ required: true, message: 'Dataset File2 is required' }],
                    filename3: [{ required: true, message: 'Dataset File3 is required' }],
                    filename4: [{ required: true, message: 'Dataset File4 is required' }],
                    datasetname: [{ required: true, message: 'Dataset name is required', trigger: 'blur' }],
                    disease: [{ required: true, message: 'Disease is required', trigger: 'blur' }],
                    phenotype: [{ required: true, message: 'Phenotype is required', trigger: 'blur' }],
                    // group: [{ required: true, message: 'Group is required', trigger: 'blur' }]
                },
                rules1: {
                    Dataset: [{ required: true, message: 'Dataset name is required', trigger: 'blur' }],
                    Disease: [{ required: true, message: 'Disease is required', trigger: 'blur' }],
                    Phenotype: [{ required: true, message: 'Phenotype is required', trigger: 'blur' }],
                    // Group: [{ required: true, message: 'Group is required', trigger: 'blur' }]
                },
                startTime: '',
                endTime: '',
                diseases: [],

                displayData: [],
                currentPage: 1, // 当前页码
                pageSizes: [10], //页码数选项
                pageSize: 10, // 每页显示的条数
                total: 0, // 数据总数
                searchField: '', // 选择的搜索字段
                searchKeyword: '', // 用户输入的搜索关键词

                editDialog: false,
                deleteVisible: false,
                deleteID: 0,

                data: {
                    name: '',
                    sex: '',
                    birthday: '',
                    career: '',
                    address: '',
                    email: '',
                    password: '',
                    repassword: ''
                },
                // 临时数据，用于在Modify时存储输入的值
                tempData: {
                    name: '',
                    sex: '',
                    birthday: '',
                    career: '',
                    address: '',
                    email: '',
                    password: '',
                    repassword: ''
                },
            }
        },
        computed: {
            getIndex() {
                // 计算表格显示数据的索引值
                return (index) => {
                    return (this.currentPage - 1) * this.pageSize + index + 1;
                };
            },
        },
        mounted() {
            this.isLoaded = true;
            this.tempData.email = this.isLogin.email;
            this.fetchDiseases();
            this.getData();
            this.getData1();
        },
        methods: {
            fetchDiseases() {
                axios.get(`./interface/manage_dataset_select.php?action=getDiseases`)
                    .then(response => {
                        console.log(response.data);
                        this.diseases = response.data;
                    })
                    .catch(error => {
                        console.error('Error fetching diseases:', error);
                    });
            },
            getData1() {
                const FormData = {
                    email: this.isLogin.email,
                    action: 'get'
                };
                axios.post('./interface/manage_user.php', {}, { params: FormData })
                    .then(response => {
                        console.log(response.data);

                        this.data.career = response.data.career;
                        this.data.name = response.data.name;
						
                        this.data.sex = response.data.sex;
                        this.data.address = response.data.address;
                        this.data.birthday = response.data.birthday;
                        this.data.email = response.data.email;
                        this.data.password = response.data.password;
                        this.data.repassword = response.data.password;

                        this.tempData.career = this.data.career;
                        this.tempData.name = this.data.name;
                        this.tempData.sex = this.data.sex;
                        this.tempData.address = this.data.address;
                        this.tempData.birthday = this.data.birthday;
                        this.tempData.email = this.data.email;
                        this.tempData.password = this.data.password;
                        this.tempData.repassword = this.data.repassword;
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });
            },
            handleSubmit() {
                // 检查密码和确认密码是否一致
                if (this.tempData.password !== this.tempData.repassword) {
                    this.$message.error('Passwords do not match');
                    return;  // 如果不一致，终止后续的axios请求
                }
                const FormData = {
                    ...this.tempData,
                    action: 'update'
                }
                axios.post('./interface/manage_user.php', {}, { params: FormData })
                    .then(response => {
                        console.log(response.data);
                        if (response.data.status == 'success') {
                            this.$message.success('update success');
                            this.getData1();
                        } else {
                            this.$message.error('update fail');
                        }
                    })
                    .catch(error => {
                        this.$message.error('update fail');
                        console.error('Error fetching data:', error);
                    });
            },
            handleReset() {
                this.getData1();
            },
            handleModify(index, row) {
                this.editDialog = true;
                console.log(row.id);
                // // 创建一个 row 的浅拷贝
                // let newRow = Object.assign({}, row);

                // // 删除不需要的属性
                // delete newRow.filedata1;
                // delete newRow.filedata2;
                this.formData = row;
                console.log(this.formData);
            },
            closeDialog() {
                //关闭对话框
                this.editDialog = false;
                // 清空表单数据
                this.$refs.formData.resetFields();
            },
            closeDialog1() {
                //关闭对话框
                this.deleteVisible = false;
            },
            handleSubmitForm() {
                // 使用Element UI的表单验证
                this.$refs.formData.validate((valid) => {
                    if (valid) {
                        // 如果所有验证都通过，则准备发送数据到后端
                        const formData = {
                            ...this.formData,
                            action: 'modify',
                        };
                        // 使用axios或者其他HTTP库发送数据
                        axios.post('./interface/manage_data.php', {}, { params: formData })
                            .then(response => {
                                if (response.data.status === 'success') {
                                    this.$message.success('Modify successfully!');
                                    this.closeDialog();
                                    this.updateDisplayData();
                                }
                                else {
                                    this.$message.error('modify failed');
                                }
                            })
                            .catch(error => {
                                this.$message.error('modify failed');
                            });
                    } else {
                        console.log('error modify!!');
                        return false;
                    }
                });
            },
            handleFile1Success(response, file) {
                console.log(response);
                this.form.filename1 = 'sampleinfo.txt' // 将文件名保存到表单数据中
            },
            handleFile2Success(response, file) {
                console.log(response);
                this.form.filename2 = 'isoforminfo.txt'; // 将文件名保存到表单数据中
            },
            handleFile3Success(response, file) {
                console.log(response);
                this.form.filename3 = 'Countmatrix.txt' // 将文件名保存到表单数据中
            },
            handleFile4Success(response, file) {
                console.log(response);
                this.form.filename4 = 'TPMmatrix.txt'; // 将文件名保存到表单数据中
            },
            handleFileError(err, file) {
                this.$message.error('File upload failed');
            },
            submitForm() {
                // 使用Element UI的表单验证
                this.$refs.form.validate((valid) => {
                    if (valid) {
                        // 如果所有验证都通过，则准备发送数据到后端
                        const formData = {
                            ...this.form,
                            action: 'submit',
                            email: this.isLogin.email,
                        };
                        let loadingInstance = this.$loading({
                            text: "Submitting, please wait...",
                        });
                        // 使用axios或者其他HTTP库发送数据
                        axios.post('./interface/manage_data.php', {}, { params: formData })
                            .then(response => {
                                if (response.data.status === 'success') {
                                    axios.post('./interface/test_r.php', {}, { params: formData })
                                        .then(response => {
                                            if (response.data.status === 'success') {
                                                loadingInstance.close();
                                                this.$message.success('Form submitted successfully!');
                                                this.$refs.form.resetFields();
                                                this.getData();
                                            } else {
                                                loadingInstance.close();
                                                this.$message.error('Form submission failed1');
                                            }
                                        })
                                        .catch(error => {
                                            loadingInstance.close();
                                            this.$message.error('Form submission failed2');
                                        });
                                }
                                else if(response.data.status === 'error'){
                                    loadingInstance.close();
                                    this.$message.error(response.data.message);
                                }else{
                                    loadingInstance.close();
                                    this.$message.error('submit failed');
                                }
                            })
                            .catch(error => {
                                loadingInstance.close();
                                this.$message.error('Form submission failed');
                            });
                    } else {
                        console.log('error submit!!');
                        return false;
                    }
                });
            },
            resetForm() {
                // 重置表单
                this.$refs.form.resetFields();
            },
            handleSearch() {
                this.loading = true;
                const formatISO = date => {
                    if (!date) return '';
                    const d = new Date(date);
                    // Adjust for time zone offset
                    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                    return d.toISOString().split('T')[0];
                };
                const newFormData = {
                    email: this.isLogin.email,
                    currentPage: this.currentPage,
                    pageSize: this.pageSize,
                    searchField: this.searchField,
                    searchKeyword: this.searchKeyword,
                    startTime: formatISO(this.startTime),
                    endTime: formatISO(this.endTime),
                    action: 'getdata'
                };
                console.log(formatISO(this.startTime));
                console.log(formatISO(this.endTime));
                axios.post('./interface/manage_data.php', {}, { params: newFormData })
                    .then(response => {
                        console.log(response);
                        this.total = response.data.total;
                        if (this.total < 10) {
                            this.pageSize = this.total;
                            this.pageSizes = [this.total, 10, 20]
                        } else {
                            this.pageSizes = [10, 20, this.total]
                        }
                        this.displayData = response.data.data;
                        this.loading = false;
                    })
                    .catch(error => {
                        this.loading = false;
                        console.error('Error:', error);
                    });

            },
            getData() {
                this.loading = true;
                const FormData = {
                    email: this.isLogin.email,
                    currentPage: this.currentPage,
                    pageSize: 10,
                    searchField: this.searchField,
                    searchKeyword: this.searchKeyword,
                    action: 'getdata'
                };
                axios.post('./interface/manage_data.php', {}, { params: FormData })
                    .then(response => {
                        console.log(response);
                        this.displayData = response.data.data;
                        this.total = response.data.total;
                        console.log(this.total);
                        if (this.total < 10) {
                            this.pageSize = this.total;
                            this.pageSizes = [this.total, 10, 20]
                        } else {
                            this.pageSizes = [10, 20, this.total]
                        }
                        this.loading = false;
                    })
                    .catch(error => {
                        console.error('Error fetching:', error);
                        this.loading = false;
                    });
            },
            updateDisplayData() {
                const FormData = {
                    email: this.isLogin.email,
                    currentPage: this.currentPage,
                    pageSize: this.pageSize,
                    searchField: this.searchField,
                    searchKeyword: this.searchKeyword,
                    action: 'getdata'
                };
                axios.post('./interface/manage_data.php', {}, { params: FormData })
                    .then(response => {
                        console.log(response);
                        this.displayData = response.data.data;
                    })
                    .catch(error => {
                        console.error('Error fetching:', error);
                    });
            },
            handleSizeChange(newSize) {
                // 每页显示条数改变时触发
                this.pageSize = newSize;
                this.currentPage = 1; // 重置当前页码
                this.updateDisplayData(); // 更新显示数据
            },
            handleCurrentChange(newPage) {
                // 当前页码改变时触发
                this.currentPage = newPage;
                this.updateDisplayData(); // 更新显示数据
            },
            resetSearch() {
                this.searchField = '';
                this.searchKeyword = '';
                this.startTime = '';
                this.endTime = '';
                this.currentPage = 1;
                this.pageSizes = [10]; //页码数选项
                this.pageSize = 10; // 每页显示的条数
                this.total = 0; // 数据总数
                this.getData();
            },
            handleDelete(index, row) {
                console.log([row]);
                this.deleteVisible = true;
                this.deleteID = row.id;
            },
            deleteData() {
                const FormData = {
                    id: this.deleteID,
                    action: 'delete'
                };
                axios.post('./interface/manage_data.php', {}, { params: FormData })
                    .then(response => {
                        console.log(response);
                        this.updateDisplayData();
                        this.deleteVisible = false;
                        this.deleteID = 0;
                        this.$message.success('delete successfully');
                    })
                    .catch(error => {
                        console.error('Error fetching:', error);
                    });
            },
            download1() {
                // 发送 AJAX 请求到 PHP 脚本
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // 创建一个 Blob 对象，并设置其类型为文件的 MIME 类型
                        var blob = new Blob([this.response], { type: 'application/octet-stream' });
                        // 创建一个下载链接
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = 'Example_SampleInfo.txt'; // 替换为您要下载的文件名
                        // 模拟点击下载链接
                        link.click();
                    }
                };
                xhttp.open('GET', './interface/download_file1.php?fileParam=Example_SampleInfo', true);
                xhttp.send();
            },
            download2() {
                // 发送 AJAX 请求到 PHP 脚本
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // 创建一个 Blob 对象，并设置其类型为文件的 MIME 类型
                        var blob = new Blob([this.response], { type: 'application/octet-stream' });
                        // 创建一个下载链接
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = 'Example_IsoformInfo.txt'; // 替换为您要下载的文件名
                        // 模拟点击下载链接
                        link.click();
                    }
                };
                xhttp.open('GET', './interface/download_file1.php?fileParam=Example_IsoformInfo', true);
                xhttp.send();
            },
            download3() {
                // 发送 AJAX 请求到 PHP 脚本
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // 创建一个 Blob 对象，并设置其类型为文件的 MIME 类型
                        var blob = new Blob([this.response], { type: 'application/octet-stream' });
                        // 创建一个下载链接
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = 'Example_CountMatrix.txt'; // 替换为您要下载的文件名
                        // 模拟点击下载链接
                        link.click();
                    }
                };
                xhttp.open('GET', './interface/download_file1.php?fileParam=Example_CountMatrix', true);
                xhttp.send();
            },
            download4() {
                // 发送 AJAX 请求到 PHP 脚本
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        // 创建一个 Blob 对象，并设置其类型为文件的 MIME 类型
                        var blob = new Blob([this.response], { type: 'application/octet-stream' });
                        // 创建一个下载链接
                        var link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = 'Example_TPMMatrix.txt'; // 替换为您要下载的文件名
                        // 模拟点击下载链接
                        link.click();
                    }
                };
                xhttp.open('GET', './interface/download_file1.php?fileParam=Example_TPMMatrix', true);
                xhttp.send();
            },
            async uploadFile({ data, file }) {
                const upload = (url, data, headers = {}) => {
                    return new Promise((resolve, reject) => {
                        axios({
                            url,
                            method: "post",
                            data,
                            headers: {
                                ...headers,
                                'Content-Type': 'multipart/form-data'
                            }
                        }).then(res => resolve(res.data))
                            .catch(err => reject(err));
                    });
                }

                const uploadByPieces = async (url, { fileName, file }) => {
                    const chunkSize = 2 * 1024 * 1024; // 2MB per chunk
                    const chunkCount = Math.ceil(file.size / chunkSize); // Total number of chunks

                    const getChunkInfo = (file, index) => {
                        let start = index * chunkSize;
                        let end = Math.min(file.size, start + chunkSize);
                        let chunk = file.slice(start, end);
                        return { start, end, chunk };
                    };

                    const uploadChunk = (data) => {
                        return new Promise((resolve, reject) => {
                            axios({
                                url,
                                method: "post",
                                data,
                                headers: {
                                    'Content-Type': 'multipart/form-data'
                                }
                            }).then(res => resolve(res.data))
                                .catch(err => reject(err));
                        });
                    }

                    // Sequentially upload each chunk
                    try {
                        for (let index = 0; index <= chunkCount; ++index) {
                            const { chunk } = getChunkInfo(file, index);
                            let fetchForm = new FormData();
                            for (let key in data) {
                                if (key != 'file') {
                                    fetchForm.append(key, data[key]);
                                }
                            }
                            fetchForm.append("chunk", chunk);
                            fetchForm.append("index", index);
                            fetchForm.append("chunkCount", chunkCount);

                            // Await the upload of each chunk before continuing
                            await uploadChunk(fetchForm);
                        }
                        return { status: 'success', message: 'All chunks uploaded successfully.' };
                    } catch (e) {
                        return { status: 'error', message: e.message };
                    }
                }

                let url = "./interface/manage_data.php"; // Upload URL
                let loadingInstance = this.$loading({
                    text: "loading...",
                });

                try {
                    // If file is smaller than 2MB, upload directly
                    if (file.size < 2 * 1024 * 1024) {
                        let formData = new FormData();
                        for (let key in data) {
                            formData.append(key, data[key]);
                        }
                        formData.append("file", file);
                        const res = await upload(url, formData);
                        loadingInstance.close();
                        return res;
                    } else {
                        // If file is 2MB or larger, upload by pieces
                        data.file = file;
                        const res = await uploadByPieces(url, data);
                        loadingInstance.close();
                        return res;
                    }
                } catch (e) {
                    loadingInstance.close();
                    return { status: 'error', message: e.message };
                }
            },


        }
    })
</script>

</html>